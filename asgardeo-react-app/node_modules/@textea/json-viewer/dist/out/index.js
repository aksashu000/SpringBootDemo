"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.JsonViewer = exports.safeStringify = exports.isCycleReference = exports.createDataType = exports.applyValue = void 0;
var jsx_runtime_1 = require("@emotion/react/jsx-runtime");
var material_1 = require("@mui/material");
var clsx_1 = require("clsx");
var react_1 = require("react");
var DataKeyPair_1 = require("./components/DataKeyPair");
var useThemeDetector_1 = require("./hooks/useThemeDetector");
var JsonViewerStore_1 = require("./stores/JsonViewerStore");
var typeRegistry_1 = require("./stores/typeRegistry");
var base16_1 = require("./theme/base16");
var utils_1 = require("./utils");
Object.defineProperty(exports, "applyValue", { enumerable: true, get: function () { return utils_1.applyValue; } });
Object.defineProperty(exports, "createDataType", { enumerable: true, get: function () { return utils_1.createDataType; } });
Object.defineProperty(exports, "isCycleReference", { enumerable: true, get: function () { return utils_1.isCycleReference; } });
Object.defineProperty(exports, "safeStringify", { enumerable: true, get: function () { return utils_1.safeStringify; } });
/**
 * @internal
 */
function useSetIfNotUndefinedEffect(key, value) {
    var setState = (0, react_1.useContext)(JsonViewerStore_1.JsonViewerStoreContext).setState;
    (0, react_1.useEffect)(function () {
        var _a;
        if (value !== undefined) {
            setState((_a = {},
                _a[key] = value,
                _a));
        }
    }, [key, value, setState]);
}
/**
 * @internal
 */
var JsonViewerInner = function (props) {
    var setState = (0, react_1.useContext)(JsonViewerStore_1.JsonViewerStoreContext).setState;
    (0, react_1.useEffect)(function () {
        setState(function (state) { return ({
            prevValue: state.value,
            value: props.value
        }); });
    }, [props.value, setState]);
    useSetIfNotUndefinedEffect('editable', props.editable);
    useSetIfNotUndefinedEffect('indentWidth', props.indentWidth);
    useSetIfNotUndefinedEffect('onChange', props.onChange);
    useSetIfNotUndefinedEffect('groupArraysAfterLength', props.groupArraysAfterLength);
    useSetIfNotUndefinedEffect('keyRenderer', props.keyRenderer);
    useSetIfNotUndefinedEffect('maxDisplayLength', props.maxDisplayLength);
    useSetIfNotUndefinedEffect('enableClipboard', props.enableClipboard);
    useSetIfNotUndefinedEffect('highlightUpdates', props.highlightUpdates);
    useSetIfNotUndefinedEffect('rootName', props.rootName);
    useSetIfNotUndefinedEffect('displayDataTypes', props.displayDataTypes);
    useSetIfNotUndefinedEffect('displayObjectSize', props.displayObjectSize);
    useSetIfNotUndefinedEffect('onCopy', props.onCopy);
    useSetIfNotUndefinedEffect('onSelect', props.onSelect);
    (0, react_1.useEffect)(function () {
        if (props.theme === 'light') {
            setState({
                colorspace: base16_1.lightColorspace
            });
        }
        else if (props.theme === 'dark') {
            setState({
                colorspace: base16_1.darkColorspace
            });
        }
        else if (typeof props.theme === 'object') {
            setState({
                colorspace: props.theme
            });
        }
    }, [setState, props.theme]);
    var themeCls = (0, react_1.useMemo)(function () {
        if (typeof props.theme === 'object')
            return 'json-viewer-theme-custom';
        return props.theme === 'dark' ? 'json-viewer-theme-dark' : 'json-viewer-theme-light';
    }, [props.theme]);
    var onceRef = (0, react_1.useRef)(true);
    var predefinedTypes = (0, react_1.useMemo)(function () { return (0, typeRegistry_1.predefined)(); }, []);
    var registerTypes = (0, typeRegistry_1.useTypeRegistryStore)(function (store) { return store.registerTypes; });
    if (onceRef.current) {
        var allTypes = props.valueTypes
            ? __spreadArray(__spreadArray([], predefinedTypes, true), props.valueTypes, true) : __spreadArray([], predefinedTypes, true);
        registerTypes(allTypes);
        onceRef.current = false;
    }
    (0, react_1.useEffect)(function () {
        var allTypes = props.valueTypes
            ? __spreadArray(__spreadArray([], predefinedTypes, true), props.valueTypes, true) : __spreadArray([], predefinedTypes, true);
        registerTypes(allTypes);
    }, [props.valueTypes, predefinedTypes, registerTypes]);
    var value = (0, JsonViewerStore_1.useJsonViewerStore)(function (store) { return store.value; });
    var prevValue = (0, JsonViewerStore_1.useJsonViewerStore)(function (store) { return store.prevValue; });
    var setHover = (0, JsonViewerStore_1.useJsonViewerStore)(function (store) { return store.setHover; });
    var onMouseLeave = (0, react_1.useCallback)(function () { return setHover(null); }, [setHover]);
    return ((0, jsx_runtime_1.jsx)(material_1.Paper, __assign({ elevation: 0, className: (0, clsx_1.default)(themeCls, props.className), style: props.style, sx: __assign({ fontFamily: 'monospace', userSelect: 'none', contentVisibility: 'auto' }, props.sx), onMouseLeave: onMouseLeave }, { children: (0, jsx_runtime_1.jsx)(DataKeyPair_1.DataKeyPair, { value: value, prevValue: prevValue, path: (0, react_1.useMemo)(function () { return []; }, []) }) })));
};
var JsonViewer = function JsonViewer(props) {
    var isAutoDarkTheme = (0, useThemeDetector_1.useThemeDetector)();
    var themeType = (0, react_1.useMemo)(function () {
        var _a;
        return props.theme === 'auto'
            ? (isAutoDarkTheme ? 'light' : 'dark')
            : (_a = props.theme) !== null && _a !== void 0 ? _a : 'light';
    }, [isAutoDarkTheme, props.theme]);
    var theme = (0, react_1.useMemo)(function () {
        var backgroundColor = typeof themeType === 'object'
            ? themeType.base00
            : themeType === 'dark'
                ? base16_1.darkColorspace.base00
                : base16_1.lightColorspace.base00;
        return (0, material_1.createTheme)({
            components: {
                MuiPaper: {
                    styleOverrides: {
                        root: {
                            backgroundColor: backgroundColor
                        }
                    }
                }
            },
            palette: {
                mode: themeType === 'dark' ? 'dark' : 'light',
                background: {
                    default: backgroundColor
                }
            }
        });
    }, [themeType]);
    var mixedProps = __assign(__assign({}, props), { theme: themeType });
    // eslint-disable-next-line react-hooks/exhaustive-deps
    var jsonViewerStore = (0, react_1.useMemo)(function () { return (0, JsonViewerStore_1.createJsonViewerStore)(props); }, []);
    var typeRegistryStore = (0, react_1.useMemo)(function () { return (0, typeRegistry_1.createTypeRegistryStore)(); }, []);
    return ((0, jsx_runtime_1.jsx)(material_1.ThemeProvider, __assign({ theme: theme }, { children: (0, jsx_runtime_1.jsx)(typeRegistry_1.TypeRegistryStoreContext.Provider, __assign({ value: typeRegistryStore }, { children: (0, jsx_runtime_1.jsx)(JsonViewerStore_1.JsonViewerStoreContext.Provider, __assign({ value: jsonViewerStore }, { children: (0, jsx_runtime_1.jsx)(JsonViewerInner, __assign({}, mixedProps)) })) })) })));
};
exports.JsonViewer = JsonViewer;
__exportStar(require("./theme/base16"), exports);
__exportStar(require("./type"), exports);
